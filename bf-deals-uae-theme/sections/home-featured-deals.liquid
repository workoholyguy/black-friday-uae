{% liquid
  assign featured_collection = section.settings.collection
  assign configured = true
  if featured_collection == blank
    assign configured = false
    assign featured_collection = collections['all']
  endif
  assign limit = section.settings.products_limit | default: 10
  assign rendered = 0
%}

<section class="home-featured-deals">
  <header class="home-featured-deals__header">
    <div class="home-featured-deals__heading">
      <h2 class="home-featured-deals__title">{{ section.settings.heading | escape }}</h2>
      <p class="home-featured-deals__trust">
        <span class="home-featured-deals__trust-item">{{ 'home.deals.limited_stock' | t }}</span>
        <span aria-hidden="true">•</span>
        <span class="home-featured-deals__trust-item">{{ 'home.deals.fast_delivery_uae' | t }}</span>
      </p>
    </div>

    <a class="home-featured-deals__link" href="{{ featured_collection.url }}">
      {{ 'home.deals.view_all' | t }}
    </a>
  </header>

  <div class="home-featured-deals__scroller" role="list" data-scroll-hint>
    {% for product in featured_collection.products %}
        {% liquid
          assign variant = product.selected_or_first_available_variant
          assign on_sale = false
          if variant.compare_at_price > variant.price
            assign on_sale = true
          endif
        %}

        {% if on_sale %}
          {% liquid
            assign compare = variant.compare_at_price
            assign price = variant.price
            assign savings = compare | minus: price
            assign percent_off = savings | times: 100 | divided_by: compare
            assign rendered = rendered | plus: 1
          %}

          <article class="home-deal-card" role="listitem">
            <a class="home-deal-card__media" href="{{ product.url }}" aria-label="{{ product.title | escape }}">
              {% if product.featured_image %}
                {% render 'image',
                  class: 'home-deal-card__image',
                  image: product.featured_image,
                  width: 900,
                  height: 900,
                  crop: 'center'
                %}
              {% else %}
                {{ 'product-1' | placeholder_svg_tag: 'home-deal-card__placeholder' }}
              {% endif %}

              <span class="home-deal-card__badge" aria-label="{{ 'home.deals.discount_badge_aria' | t: percent: percent_off }}">
                -{{ percent_off }}%
              </span>
            </a>

            <div class="home-deal-card__content">
              <h3 class="home-deal-card__title">
                <a href="{{ product.url }}">{{ product.title | escape }}</a>
              </h3>
              <div class="home-deal-card__price">
                <span class="home-deal-card__price-current">{{ price | money }}</span>
                <s class="home-deal-card__price-compare">{{ compare | money }}</s>
              </div>

              {% if product.available and variant != blank and variant.available %}
                <form
                  class="home-deal-card__form"
                  action="{{ routes.cart_add_url }}"
                  method="post"
                  enctype="multipart/form-data"
                  data-quick-add
                >
                  <input type="hidden" name="id" value="{{ variant.id }}">
                  <input type="hidden" name="quantity" value="1">
                  <button
                    class="home-deal-card__cta"
                    type="submit"
                    data-label-default="{{ 'products.add_to_cart' | t | escape }}"
                    data-label-added="{{ 'products.added_to_cart' | t | escape }}"
                    data-label-error="{{ 'products.add_to_cart_error' | t | escape }}"
                  >
                    {{ 'products.add_to_cart' | t }}
                  </button>
                </form>
              {% else %}
                <button class="home-deal-card__cta home-deal-card__cta--disabled" type="button" disabled>
                  {{ 'products.sold_out' | t }}
                </button>
              {% endif %}
            </div>
          </article>

          {% if rendered >= limit %}
            {% break %}
          {% endif %}
        {% endif %}
    {% endfor %}

    {% if rendered == 0 %}
      <div class="home-featured-deals__empty" role="listitem">
        {% if configured %}
          {{ 'home.deals.no_deals' | t }}
        {% else %}
          {{ 'home.deals.pick_collection' | t }}
        {% endif %}
      </div>
    {% endif %}
    <div class="scroll-hint" aria-hidden="true"></div>
  </div>
</section>

{% stylesheet %}
  .home-featured-deals {
    padding: clamp(1.25rem, 4vw, 2.5rem) var(--page-margin);
  }

  .home-featured-deals__header {
    display: flex;
    align-items: end;
    justify-content: space-between;
    gap: 1rem;
    margin-block-end: 1rem;
  }

  .home-featured-deals__title {
    font-size: clamp(1.25rem, 2.2vw, 1.6rem);
    font-weight: 800;
    letter-spacing: -0.02em;
  }

  .home-featured-deals__trust {
    margin-top: 0.3rem;
    opacity: 0.8;
    font-size: 0.95rem;
  }

  .home-featured-deals__link {
    font-weight: 800;
    color: var(--color-primary);
    text-decoration: none;
    white-space: nowrap;
  }

  .home-featured-deals__scroller {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    padding-block: 0.15rem 0.5rem;
  }

  .home-featured-deals__scroller .scroll-hint {
    position: sticky;
    right: 0;
    align-self: stretch;
    flex: 0 0 44px;
    pointer-events: none;
    display: grid;
    place-items: center;
    background: linear-gradient(
      90deg,
      transparent 0%,
      color-mix(in srgb, var(--color-background) 40%, transparent) 40%,
      color-mix(in srgb, var(--color-background) 92%, transparent) 100%
    );
    opacity: 0.95;
    transition: opacity 160ms ease;
  }

  .home-featured-deals__scroller .scroll-hint::after {
    content: '';
    width: 10px;
    height: 10px;
    border-inline-end: 3px solid color-mix(in srgb, var(--color-foreground) 65%, transparent);
    border-block-start: 3px solid color-mix(in srgb, var(--color-foreground) 65%, transparent);
    transform: rotate(45deg);
    animation: homeFeaturedDealsScrollHint 1.35s ease-in-out infinite;
  }

  .home-featured-deals__scroller.is-not-scrollable .scroll-hint,
  .home-featured-deals__scroller.is-at-end .scroll-hint {
    opacity: 0;
  }

  @keyframes homeFeaturedDealsScrollHint {
    0%,
    100% {
      transform: translateX(0) rotate(45deg);
    }
    50% {
      transform: translateX(5px) rotate(45deg);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .home-featured-deals__scroller .scroll-hint::after {
      animation: none;
    }
  }

  .home-deal-card {
    scroll-snap-align: start;
    flex: 0 0 min(78vw, 240px);
    border-radius: 18px;
    overflow: hidden;
    border: 1px solid color-mix(in srgb, var(--color-foreground) 12%, transparent);
    background: color-mix(in srgb, var(--color-background) 96%, var(--color-foreground) 4%);
  }

  .home-deal-card__media {
    position: relative;
    display: block;
    background: color-mix(in srgb, var(--color-foreground) 6%, transparent);
    aspect-ratio: 16 / 9;
  }

  .home-deal-card__media .image {
    height: 100%;
  }

  .home-deal-card__image > img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .home-deal-card__placeholder {
    width: 100%;
    height: 100%;
  }

  .home-deal-card__badge {
    position: absolute;
    inset-block-start: 12px;
    inset-inline-start: 12px;
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 0.72rem;
    font-weight: 900;
    color: var(--color-primary);
    backdrop-filter: blur(10px);
    background: color-mix(in srgb, var(--color-background) 78%, transparent);
    border: 1px solid color-mix(in srgb, var(--color-foreground) 14%, transparent);
  }

  .home-deal-card__content {
    padding: 7px 9px 9px 9px;
    display: grid;
    gap: 4px;
  }

  .home-deal-card__title {
    font-size: 0.86rem;
    line-height: 1.2;
  }

  .home-deal-card__title a {
    color: inherit;
    text-decoration: none;
  }

  .home-deal-card__price {
    display: flex;
    gap: 10px;
    align-items: baseline;
  }

  .home-deal-card__price-current {
    font-weight: 900;
    letter-spacing: -0.01em;
    color: var(--color-primary);
  }

  .home-deal-card__price-compare {
    opacity: 0.65;
  }

  .home-deal-card__cta {
    width: 100%;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    border: 0;
    border-radius: 999px;
    padding: 0.55rem 0.75rem;
    background: var(--color-primary);
    color: var(--color-accent);
    font-weight: 900;
    cursor: pointer;
    transition: transform 160ms ease, opacity 160ms ease;
    user-select: none;
  }

  .home-deal-card__cta:hover {
    transform: translateY(-1px);
  }

  .home-deal-card__cta:active {
    transform: translateY(0);
  }

  .home-deal-card__cta--disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .home-deal-card__cta.is-loading {
    opacity: 0.8;
    cursor: progress;
  }

  @media (max-width: 900px) {
    .home-featured-deals__header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.4rem;
    }
    .home-featured-deals__link {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }
  }

  @media (max-width: 750px) {
    .home-featured-deals {
      padding: clamp(1rem, 4vw, 1.5rem) var(--page-margin);
    }
    .home-featured-deals__scroller {
      gap: 0.75rem;
      padding-inline-end: 0.25rem;
    }
    .home-deal-card {
      flex-basis: min(82vw, 240px);
    }
    .home-featured-deals__title {
      font-size: clamp(1.1rem, 4vw, 1.35rem);
    }
    .home-featured-deals__trust {
      font-size: 0.9rem;
    }
  }
{% endstylesheet %}

{% javascript %}
  const sectionRoot = document.currentScript?.closest('.shopify-section')
  if (sectionRoot) {
    const scrollers = sectionRoot.querySelectorAll('[data-scroll-hint]')
    const update = (el) => {
      const maxScroll = el.scrollWidth - el.clientWidth
      const scrollable = maxScroll > 2
      el.classList.toggle('is-not-scrollable', !scrollable)
      if (!scrollable) {
        el.classList.remove('is-at-end')
        return
      }
      el.classList.toggle('is-at-end', el.scrollLeft >= maxScroll - 2)
    }

    scrollers.forEach((el) => {
      const run = () => update(el)
      run()
      el.addEventListener('scroll', run, { passive: true })
      window.addEventListener('resize', run, { passive: true })
    })
  }
{% endjavascript %}

{% schema %}
{
  "name": "Home featured deals",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Today’s top deals"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Source collection"
    },
    {
      "type": "range",
      "id": "products_limit",
      "label": "Products to show",
      "min": 4,
      "max": 16,
      "step": 1,
      "default": 12
    }
  ],
  "presets": [
    {
      "name": "Home featured deals"
    }
  ]
}
{% endschema %}


