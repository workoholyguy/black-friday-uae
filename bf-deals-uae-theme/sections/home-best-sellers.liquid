{% liquid
  assign source_collection = section.settings.collection
  assign configured = true
  if source_collection == blank
    assign configured = false
    assign source_collection = collections['all']
  endif
  assign limit = section.settings.products_limit | default: 10

  assign view_all_url = source_collection.url
  if view_all_url contains '?'
    assign view_all_url = view_all_url | append: '&sort_by=best-selling'
  else
    assign view_all_url = view_all_url | append: '?sort_by=best-selling'
  endif
%}

<section class="home-best-sellers">
  <header class="home-best-sellers__header">
    <div class="home-best-sellers__heading">
      <h2 class="home-best-sellers__title">{{ section.settings.heading | escape }}</h2>
      {% if section.settings.subheading != blank %}
        <p class="home-best-sellers__sub">{{ section.settings.subheading | escape }}</p>
      {% endif %}
    </div>

    <a class="home-best-sellers__link" href="{{ view_all_url }}">
      {{ 'home.best_sellers.view_all' | t }}
    </a>
  </header>

  {% if configured == false %}
    <p class="home-best-sellers__notice">
      {{ 'home.best_sellers.pick_collection' | t }}
    </p>
  {% endif %}

  <div class="home-best-sellers__scroller" role="list" data-scroll-hint>
    {% for product in source_collection.products limit: limit %}
      <div class="home-best-sellers__item" role="listitem">
        {% render 'product-card', product: product, show_vendor: false, show_price: true, class: 'product-card--compact' %}
      </div>
    {% endfor %}
    <div class="scroll-hint" aria-hidden="true"></div>
  </div>
</section>

{% stylesheet %}
  .home-best-sellers {
    padding: clamp(1.25rem, 4vw, 2.5rem) var(--page-margin);
  }

  .home-best-sellers__header {
    display: flex;
    align-items: end;
    justify-content: space-between;
    gap: 1rem;
    margin-block-end: 1rem;
  }

  .home-best-sellers__title {
    font-size: clamp(1.25rem, 2.2vw, 1.6rem);
    font-weight: 800;
    letter-spacing: -0.02em;
  }

  .home-best-sellers__sub {
    margin-top: 0.3rem;
    opacity: 0.8;
    font-size: 0.95rem;
  }

  .home-best-sellers__notice {
    margin-block: -0.25rem 0.75rem;
    opacity: 0.8;
  }

  .home-best-sellers__link {
    font-weight: 800;
    color: var(--color-primary);
    text-decoration: none;
  }

  .home-best-sellers__scroller {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    padding-block: 0.15rem 0.5rem;
  }

  .home-best-sellers__item {
    scroll-snap-align: start;
    flex: 0 0 min(62vw, 220px);
  }

  .home-best-sellers__scroller .scroll-hint {
    position: sticky;
    right: 0;
    align-self: stretch;
    flex: 0 0 44px;
    pointer-events: none;
    display: grid;
    place-items: center;
    background: linear-gradient(
      90deg,
      transparent 0%,
      color-mix(in srgb, var(--color-background) 40%, transparent) 40%,
      color-mix(in srgb, var(--color-background) 92%, transparent) 100%
    );
    opacity: 0.95;
    transition: opacity 160ms ease;
  }

  .home-best-sellers__scroller .scroll-hint::after {
    content: '';
    width: 10px;
    height: 10px;
    border-inline-end: 3px solid color-mix(in srgb, var(--color-foreground) 65%, transparent);
    border-block-start: 3px solid color-mix(in srgb, var(--color-foreground) 65%, transparent);
    transform: rotate(45deg);
    animation: homeBestSellersScrollHint 1.35s ease-in-out infinite;
  }

  .home-best-sellers__scroller.is-not-scrollable .scroll-hint,
  .home-best-sellers__scroller.is-at-end .scroll-hint {
    opacity: 0;
  }

  @keyframes homeBestSellersScrollHint {
    0%,
    100% {
      transform: translateX(0) rotate(45deg);
    }
    50% {
      transform: translateX(5px) rotate(45deg);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .home-best-sellers__scroller .scroll-hint::after {
      animation: none;
    }
  }
{% endstylesheet %}

{% javascript %}
  const sectionRoot = document.currentScript?.closest('.shopify-section')
  if (sectionRoot) {
    const scrollers = sectionRoot.querySelectorAll('[data-scroll-hint]')
    const update = (el) => {
      const maxScroll = el.scrollWidth - el.clientWidth
      const scrollable = maxScroll > 2
      el.classList.toggle('is-not-scrollable', !scrollable)
      if (!scrollable) {
        el.classList.remove('is-at-end')
        return
      }
      el.classList.toggle('is-at-end', el.scrollLeft >= maxScroll - 2)
    }

    scrollers.forEach((el) => {
      const run = () => update(el)
      run()
      el.addEventListener('scroll', run, { passive: true })
      window.addEventListener('resize', run, { passive: true })
    })
  }
{% endjavascript %}

{% schema %}
{
  "name": "Home best sellers",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Best sellers this week"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Popular picks right now"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Best sellers collection (set sort to Best selling)"
    },
    {
      "type": "range",
      "id": "products_limit",
      "label": "Products to show",
      "min": 4,
      "max": 10,
      "step": 1,
      "default": 10
    }
  ],
  "presets": [
    {
      "name": "Home best sellers"
    }
  ]
}
{% endschema %}


