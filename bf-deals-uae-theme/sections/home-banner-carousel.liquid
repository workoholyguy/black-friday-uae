{% if section.blocks.size > 0 %}
  <section
    class="banner-carousel"
    style="
      --banner-max-width: {{ section.settings.max_width }}px;
      --banner-radius: {{ section.settings.radius }}px;
      --banner-gap: {{ section.settings.gap }}px;
    "
    data-banner-carousel
  >
    {% if section.settings.heading != blank %}
      <div class="banner-carousel__header">
        <h2 class="banner-carousel__title">{{ section.settings.heading | escape }}</h2>
      </div>
    {% endif %}

    <div class="banner-carousel__viewport" data-track>
      {% for block in section.blocks %}
        {% assign image = block.settings.image %}
        {% assign link = block.settings.link %}
        {% assign asset_name = block.settings.asset %}
        {% assign is_active = false %}
        {% if forloop.first %}
          {% assign is_active = true %}
        {% endif %}
        {% if image %}
          {% if link != blank %}
            <a
              class="banner-carousel__slide{% if is_active %} is-active{% endif %}"
              href="{{ link }}"
              data-slide
              aria-hidden="{% if is_active %}false{% else %}true{% endif %}"
              {{ block.shopify_attributes }}
            >
              {{ image | image_url: width: 2000 | image_tag: loading: 'lazy', alt: block.settings.alt_text | default: image.alt | default: '', class: 'banner-carousel__image' }}
            </a>
          {% else %}
            <div class="banner-carousel__slide{% if is_active %} is-active{% endif %}" data-slide aria-hidden="{% if is_active %}false{% else %}true{% endif %}" {{ block.shopify_attributes }}>
              {{ image | image_url: width: 2000 | image_tag: loading: 'lazy', alt: block.settings.alt_text | default: image.alt | default: '', class: 'banner-carousel__image' }}
            </div>
          {% endif %}
        {% elsif asset_name != blank %}
          {% if link != blank %}
            <a
              class="banner-carousel__slide{% if is_active %} is-active{% endif %}"
              href="{{ link }}"
              data-slide
              aria-hidden="{% if is_active %}false{% else %}true{% endif %}"
              {{ block.shopify_attributes }}
            >
              <img
                class="banner-carousel__image"
                src="{{ asset_name | asset_url }}"
                alt="{{ block.settings.alt_text | escape }}"
                loading="lazy"
                width="1600"
                height="900"
              >
            </a>
          {% else %}
            <div class="banner-carousel__slide{% if is_active %} is-active{% endif %}" data-slide aria-hidden="{% if is_active %}false{% else %}true{% endif %}" {{ block.shopify_attributes }}>
              <img
                class="banner-carousel__image"
                src="{{ asset_name | asset_url }}"
                alt="{{ block.settings.alt_text | escape }}"
                loading="lazy"
                width="1600"
                height="900"
              >
            </div>
          {% endif %}
        {% else %}
          <div class="banner-carousel__slide banner-carousel__slide--placeholder{% if is_active %} is-active{% endif %}" data-slide aria-hidden="{% if is_active %}false{% else %}true{% endif %}" {{ block.shopify_attributes }}>
            <div class="banner-carousel__placeholder">
              {{ 'image' | placeholder_svg_tag: 'banner-carousel__placeholder-icon' }}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="banner-carousel__controls">
      <button type="button" class="banner-carousel__btn" data-prev aria-label="{{ 'banner.carousel.prev' | t }}">&lsaquo;</button>
      <div class="banner-carousel__dots" data-dots></div>
      <button type="button" class="banner-carousel__btn" data-next aria-label="{{ 'banner.carousel.next' | t }}">&rsaquo;</button>
    </div>
  </section>
{% endif %}

{% stylesheet %}
  .banner-carousel {
    display: grid;
    gap: 12px;
    padding: clamp(0.75rem, 4vw, 1.5rem) var(--page-margin);
  }
  .banner-carousel__header {
    display: flex;
    justify-content: center;
  }
  .banner-carousel__title {
    font-size: clamp(1.4rem, 4vw, 2rem);
    letter-spacing: -0.02em;
    text-align: center;
  }
  .banner-carousel__viewport {
    gap: var(--banner-gap);
    overflow: hidden;
    position: relative;
  }
  .banner-carousel__slide {
    display: none;
    opacity: 0;
    width: 100%;
    max-width: var(--banner-max-width);
    margin-left: auto;
    margin-right: auto;
    border-radius: var(--banner-radius);
    overflow: hidden;
    box-shadow: 0 14px 36px rgba(0, 0, 0, 0.08);
    background: var(--color-background);
  }
  .banner-carousel__slide.is-active {
    display: block;
    opacity: 1;
    transition: opacity 220ms ease;
  }
  .banner-carousel__slide--placeholder {
    display: grid;
    place-items: center;
  }
  .banner-carousel__placeholder {
    width: 100%;
    height: 100%;
    display: grid;
    place-items: center;
    background: rgba(0, 0, 0, 0.04);
  }
  .banner-carousel__placeholder-icon {
    width: 48px;
    height: 48px;
    opacity: 0.4;
  }
  .banner-carousel__image {
    display: block;
    width: 100%;
    height: auto;
  }
  .banner-carousel__controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  .banner-carousel__btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.18);
    background: var(--color-background);
    color: var(--color-foreground);
    cursor: pointer;
    display: grid;
    place-items: center;
    font-size: 1.2rem;
    transition: transform 160ms ease, box-shadow 160ms ease;
  }
  .banner-carousel__btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
  }
  .banner-carousel__dots {
    display: inline-flex;
    gap: 6px;
  }
  .banner-carousel__dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: rgba(0, 0, 0, 0.25);
    opacity: 0.35;
    transition: opacity 150ms ease, width 150ms ease;
  }
  .banner-carousel__dot.is-active {
    width: 18px;
    opacity: 1;
  }
  @media (max-width: 900px) {
    .banner-carousel__slide {
      border-radius: clamp(10px, 4vw, var(--banner-radius));
    }
  }
{% endstylesheet %}

{% javascript %}
  (function() {
    function initCarousel(root) {
      if (!root) return;
      if (root.getAttribute('data-carousel-init') === '1') return;
      root.setAttribute('data-carousel-init', '1');

      var slides = Array.prototype.slice.call(root.querySelectorAll('[data-slide]'));
      var prev = root.querySelector('[data-prev]');
      var next = root.querySelector('[data-next]');
      var dotsWrap = root.querySelector('[data-dots]');
      if (!slides.length || !prev || !next || !dotsWrap) return;

      var prefersReduced = false;
      try {
        prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      } catch (e) {}

      var index = 0;
      for (var i = 0; i < slides.length; i++) {
        if (slides[i].classList.contains('is-active')) {
          index = i;
          break;
        }
      }

      function renderDots() {
        dotsWrap.innerHTML = '';
        for (var i = 0; i < slides.length; i++) {
          var dot = document.createElement('button');
          dot.type = 'button';
          dot.className = 'banner-carousel__dot' + (i === index ? ' is-active' : '');
          dot.setAttribute('aria-label', String(i + 1));
          (function(ii) {
            dot.addEventListener('click', function() {
              goTo(ii);
              stopAutoplay();
            });
          })(i);
          dotsWrap.appendChild(dot);
        }
      }

      function setActive(i) {
        for (var j = 0; j < slides.length; j++) {
          var isActive = j === i;
          slides[j].classList.toggle('is-active', isActive);
          slides[j].setAttribute('aria-hidden', isActive ? 'false' : 'true');
        }
        index = i;
        renderDots();
      }

      function goTo(i) {
        var nextIndex = i % slides.length;
        if (nextIndex < 0) nextIndex = slides.length - 1;
        setActive(nextIndex);
      }

      var timer = null;
      function startAutoplay() {
        if (prefersReduced) return;
        if (timer) return;
        timer = window.setInterval(function() {
          goTo(index + 1);
        }, 2000);
      }

      function stopAutoplay() {
        if (!timer) return;
        window.clearInterval(timer);
        timer = null;
      }

      prev.addEventListener('click', function() {
        goTo(index - 1);
        stopAutoplay();
      });
      next.addEventListener('click', function() {
        goTo(index + 1);
        stopAutoplay();
      });

      root.addEventListener('mouseenter', stopAutoplay);
      root.addEventListener('mouseleave', startAutoplay);
      root.addEventListener('focusin', stopAutoplay);
      root.addEventListener('focusout', startAutoplay);

      renderDots();
      startAutoplay();
    }

    function initAll() {
      var carousels = document.querySelectorAll('[data-banner-carousel]');
      for (var i = 0; i < carousels.length; i++) initCarousel(carousels[i]);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAll);
    } else {
      initAll();
    }

    document.addEventListener('shopify:section:load', function(e) {
      if (!e || !e.target) return;
      var carousel = e.target.querySelector('[data-banner-carousel]');
      if (carousel) initCarousel(carousel);
    });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Banner carousel",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Spotlight deals"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Max width",
      "min": 800,
      "max": 2000,
      "step": 20,
      "unit": "px",
      "default": 1400
    },
    {
      "type": "range",
      "id": "radius",
      "label": "Corner radius",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 18
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Slide gap",
      "min": 4,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 12
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "select",
          "id": "asset",
          "label": "Theme asset (optional)",
          "options": [
            { "value": "", "label": "None" },
            { "value": "BANNER 1.png", "label": "BANNER 1.png" },
            { "value": "BANNER 2.png", "label": "BANNER 2.png" },
            { "value": "BANNER 3.png", "label": "BANNER 3.png" },
            { "value": "BANNER 4.png", "label": "BANNER 4.png" }
          ],
          "default": ""
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "alt_text",
          "label": "Alt text"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link (optional)"
        }
      ]
    }
  ],
  "max_blocks": 8,
  "presets": [
    {
      "name": "Banner carousel",
      "blocks": [
        { "type": "image" },
        { "type": "image" },
        { "type": "image" }
      ]
    }
  ]
}
{% endschema %}

