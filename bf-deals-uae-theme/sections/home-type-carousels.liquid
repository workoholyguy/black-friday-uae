{% liquid
  assign source_collection = section.settings.collection
  if source_collection == blank
    assign source_collection = collections.all
  endif

  assign heading = section.settings.heading
  assign max_types = section.settings.max_types | default: 6
  assign items_per_type = section.settings.items_per_type | default: 8
%}

<section class="home-type-carousels">
  <header class="home-type-carousels__header">
    <h2 class="home-type-carousels__title">
      {% if heading != blank %}
        {{ heading | escape }}
      {% else %}
        {{ 'home.type_carousels.heading' | t }}
      {% endif %}
    </h2>
  </header>

  {% if source_collection == blank or source_collection.products_count == 0 %}
    <div class="home-type-carousels__empty">
      {{ 'home.type_carousels.empty' | t }}
    </div>
  {% else %}
    {% paginate source_collection.products by section.settings.sample_size %}
      {% assign types = '' | split: '' %}

      {% for product in source_collection.products %}
        {% if product.type != blank %}
          {% assign type_array = product.type | split: '||' %}
          {% assign types = types | concat: type_array %}
        {% endif %}
      {% endfor %}

      {% assign unique_types = types | uniq | sort %}

      {% if unique_types.size == 0 %}
        <div class="home-type-carousels__empty">
          {{ 'home.type_carousels.no_types' | t }}
        </div>
      {% else %}
        {% liquid
          assign products_page_url = routes.all_products_collection_url
          if pages.products != blank
            assign products_page_url = pages.products.url
          endif
        %}

        {% for type in unique_types limit: max_types %}
          {% assign type_trimmed = type | strip %}
          {% if type_trimmed != blank %}
            <section class="home-type-carousel" aria-label="{{ type_trimmed | escape }}">
              <header class="home-type-carousel__header">
                <h3 class="home-type-carousel__title">{{ type_trimmed | escape }}</h3>
                <a class="home-type-carousel__link" href="{{ products_page_url }}?type={{ type_trimmed | url_encode }}">
                  {{ 'home.general.view_all' | t }}
                </a>
              </header>

              <div class="home-type-carousel__scroller" role="list" data-scroll-hint>
                {% assign shown = 0 %}

                {% for product in source_collection.products %}
                  {% liquid
                    assign product_types = '' | split: ''
                    if product.type != blank
                      assign product_types = product.type | split: '||'
                    endif
                    assign matches = false
                    if product_types contains type_trimmed
                      assign matches = true
                    endif
                  %}

                  {% if matches %}
                    <div class="home-type-carousel__item" role="listitem">
                      {% render 'product-card',
                        product: product,
                        show_vendor: false,
                        show_price: true,
                        class: 'product-card--compact'
                      %}
                    </div>
                    {% assign shown = shown | plus: 1 %}
                    {% if shown >= items_per_type %}
                      {% break %}
                    {% endif %}
                  {% endif %}
                {% endfor %}

                {% if shown == 0 %}
                  <div class="home-type-carousel__hint" role="listitem">
                    {{ 'home.type_carousels.no_products_for_type' | t }}
                  </div>
                {% endif %}
                <div class="scroll-hint" aria-hidden="true"></div>
              </div>
            </section>
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endpaginate %}
  {% endif %}
</section>

{% stylesheet %}
  .home-type-carousels {
    padding: clamp(1.25rem, 4vw, 2.5rem) var(--page-margin);
    display: grid;
    gap: clamp(1.25rem, 4vw, 2.2rem);
  }

  .home-type-carousels__header {
    margin-block-end: -0.4rem;
  }

  .home-type-carousels__title {
    font-size: clamp(1.25rem, 2.2vw, 1.6rem);
    font-weight: 800;
    letter-spacing: -0.02em;
  }

  .home-type-carousel__header {
    display: flex;
    align-items: end;
    justify-content: space-between;
    gap: 1rem;
    margin-block-end: 0.9rem;
  }

  .home-type-carousel__title {
    font-size: 1.05rem;
    font-weight: 850;
    letter-spacing: -0.01em;
  }

  .home-type-carousel__link {
    font-weight: 800;
    color: var(--color-primary);
    text-decoration: none;
    white-space: nowrap;
  }

  .home-type-carousel__scroller {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    padding-block: 0.15rem 0.5rem;
  }

  .home-type-carousel__scroller .scroll-hint {
    position: sticky;
    right: 0;
    align-self: stretch;
    flex: 0 0 44px;
    pointer-events: none;
    display: grid;
    place-items: center;
    background: linear-gradient(
      90deg,
      transparent 0%,
      color-mix(in srgb, var(--color-background) 40%, transparent) 40%,
      color-mix(in srgb, var(--color-background) 92%, transparent) 100%
    );
    opacity: 0.95;
    transition: opacity 160ms ease;
  }

  .home-type-carousel__scroller .scroll-hint::after {
    content: '';
    width: 10px;
    height: 10px;
    border-inline-end: 3px solid color-mix(in srgb, var(--color-foreground) 65%, transparent);
    border-block-start: 3px solid color-mix(in srgb, var(--color-foreground) 65%, transparent);
    transform: rotate(45deg);
    animation: homeTypeCarouselsScrollHint 1.35s ease-in-out infinite;
  }

  .home-type-carousel__scroller.is-not-scrollable .scroll-hint,
  .home-type-carousel__scroller.is-at-end .scroll-hint {
    opacity: 0;
  }

  @keyframes homeTypeCarouselsScrollHint {
    0%,
    100% {
      transform: translateX(0) rotate(45deg);
    }
    50% {
      transform: translateX(5px) rotate(45deg);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .home-type-carousel__scroller .scroll-hint::after {
      animation: none;
    }
  }

  .home-type-carousel__item {
    scroll-snap-align: start;
    flex: 0 0 min(78vw, 240px);
  }

  .home-type-carousel__hint {
    opacity: 0.8;
    padding: 0.75rem 0.9rem;
    border-radius: 14px;
    border: 1px solid color-mix(in srgb, var(--color-foreground) 12%, transparent);
    background: color-mix(in srgb, var(--color-background) 96%, var(--color-foreground) 4%);
  }

  @media (min-width: 1000px) {
    .home-type-carousel__scroller {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      overflow: visible;
      scroll-snap-type: none;
    }

    .home-type-carousel__item {
      flex: initial;
    }
  }

  @media (max-width: 900px) {
    .home-type-carousel__header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.4rem;
    }
  }

  @media (max-width: 750px) {
    .home-type-carousels {
      padding: clamp(1rem, 4vw, 1.5rem) var(--page-margin);
    }
    .home-type-carousel__scroller {
      gap: 0.75rem;
      padding-inline-end: 0.25rem;
    }
    .home-type-carousel__title {
      font-size: 1rem;
    }
  }
{% endstylesheet %}

{% javascript %}
  const sectionRoot = document.currentScript?.closest('.shopify-section');
  if (sectionRoot) {
    const scrollers = sectionRoot.querySelectorAll('[data-scroll-hint]');
    const update = (el) => {
      const maxScroll = el.scrollWidth - el.clientWidth;
      const scrollable = maxScroll > 2;
      el.classList.toggle('is-not-scrollable', !scrollable);
      if (!scrollable) {
        el.classList.remove('is-at-end');
        return;
      }
      el.classList.toggle('is-at-end', el.scrollLeft >= maxScroll - 2);
    };

    scrollers.forEach((el) => {
      const run = () => update(el);
      run();
      el.addEventListener('scroll', run, { passive: true });
      window.addEventListener('resize', run, { passive: true });
    });
  }
{% endjavascript %}

{% schema %}
{
  "name": "Home type carousels",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Shop by category"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Source collection (default: all products)"
    },
    {
      "type": "range",
      "id": "sample_size",
      "label": "Products to scan for types",
      "min": 8,
      "max": 50,
      "step": 2,
      "default": 24
    },
    {
      "type": "range",
      "id": "max_types",
      "label": "Max carousels",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 6
    },
    {
      "type": "range",
      "id": "items_per_type",
      "label": "Products per carousel",
      "min": 4,
      "max": 16,
      "step": 1,
      "default": 8
    }
  ],
  "presets": [
    {
      "name": "Home type carousels"
    }
  ]
}
{% endschema %}
