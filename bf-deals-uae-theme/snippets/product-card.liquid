{% doc %}
  Renders a product card (image, title, optional vendor, price, and badges).

  @param {product} product - The product to render
  @param {boolean} [show_vendor] - Show product vendor
  @param {boolean} [show_price] - Show product price
  @param {string} [class] - Optional extra class for the card wrapper

  @example
  {% render 'product-card', product: product, show_vendor: true, show_price: true %}
{% enddoc %}

{% liquid
  assign show_vendor = show_vendor | default: false
  assign show_price = show_price | default: true
  assign variant = product.selected_or_first_available_variant

  assign on_sale = false
  if variant.compare_at_price > variant.price
    assign on_sale = true
  endif
%}

<article class="product-card {{ class }}">
  <a class="product-card__media" href="{{ product.url }}" aria-label="{{ product.title | escape }}">
    {% if product.featured_image %}
      {% render 'image',
        class: 'product-card__image',
        image: product.featured_image,
        width: 900,
        height: 900,
        crop: 'center'
      %}
    {% else %}
      {{ 'product-1' | placeholder_svg_tag: 'product-card__placeholder' }}
    {% endif %}

    {% if product.available == false %}
      <span class="product-card__badge product-card__badge--soldout">
        {{ 'products.sold_out' | t }}
      </span>
    {% else %}
      {% if on_sale %}
        <span class="product-card__badge product-card__badge--sale">
          {{ 'products.sale' | t }}
        </span>
      {% endif %}
    {% endif %}
  </a>

  <div class="product-card__content">
    {% if show_vendor and product.vendor != blank %}
      <p class="product-card__vendor">{{ product.vendor | escape }}</p>
    {% endif %}

    <h3 class="product-card__title">
      <a href="{{ product.url }}">{{ product.title | escape }}</a>
    </h3>

    {% if show_price %}
      <div class="product-card__price">
        <span class="product-card__price-current">{{ variant.price | money }}</span>
        {% if on_sale %}
          <s class="product-card__price-compare">{{ variant.compare_at_price | money }}</s>
        {% endif %}
      </div>
    {% endif %}

    {% if product.available and variant != blank and variant.available %}
      <form
        class="product-card__form"
        action="{{ routes.cart_add_url }}"
        method="post"
        enctype="multipart/form-data"
        data-quick-add
      >
        <input type="hidden" name="id" value="{{ variant.id }}">
        <input type="hidden" name="quantity" value="1">
        <button
          class="product-card__cta"
          type="submit"
          data-label-default="{{ 'products.add_to_cart' | t | escape }}"
          data-label-added="{{ 'products.added_to_cart' | t | escape }}"
          data-label-error="{{ 'products.add_to_cart_error' | t | escape }}"
        >
          {{ 'products.add_to_cart' | t }}
        </button>
      </form>
    {% else %}
      <button class="product-card__cta product-card__cta--disabled" type="button" disabled>
        {{ 'products.sold_out' | t }}
      </button>
    {% endif %}
  </div>
</article>

{% stylesheet %}
  .product-card {
    border-radius: 18px;
    overflow: hidden;
    border: 1px solid color-mix(in srgb, var(--color-foreground) 12%, transparent);
    background: color-mix(in srgb, var(--color-background) 96%, var(--color-foreground) 4%);
    box-shadow: 0 14px 30px color-mix(in srgb, var(--color-foreground) 10%, transparent);
    transition: transform 160ms ease;
  }

  .product-card:hover {
    transform: translateY(-2px);
  }

  .product-card__media {
    position: relative;
    display: block;
    background: color-mix(in srgb, var(--color-foreground) 6%, transparent);
    aspect-ratio: var(--product-card-media-ratio, 1 / 1);
  }

  .product-card__media .image {
    height: 100%;
  }

  .product-card__image > img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .product-card__placeholder {
    width: 100%;
    height: 100%;
  }

  .product-card__badge {
    position: absolute;
    inset-block-start: 12px;
    inset-inline-start: 12px;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 700;
    backdrop-filter: blur(10px);
    background: color-mix(in srgb, var(--color-background) 78%, transparent);
    border: 1px solid color-mix(in srgb, var(--color-foreground) 14%, transparent);
  }

  .product-card__badge--sale {
    color: color-mix(in srgb, #f04438 80%, var(--color-foreground));
  }

  .product-card__badge--soldout {
    opacity: 0.85;
  }

  .product-card__content {
    padding: 12px 14px 14px 14px;
    display: grid;
    gap: 6px;
  }

  .product-card__vendor {
    font-size: 0.85rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    opacity: 0.75;
  }

  .product-card__title {
    font-size: 1rem;
    line-height: 1.25;
  }

  .product-card__title a {
    color: inherit;
    text-decoration: none;
  }

  .product-card__title a:hover {
    color: var(--color-link);
  }

  .product-card__price {
    display: flex;
    gap: 10px;
    align-items: baseline;
  }

  .product-card__price-current {
    font-weight: 800;
    letter-spacing: -0.01em;
  }

  .product-card__price-compare {
    opacity: 0.65;
  }

  .product-card__form {
    margin-top: 0.25rem;
  }

  .product-card__cta {
    width: 100%;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    border: 0;
    border-radius: 999px;
    padding: 0.65rem 0.9rem;
    background: var(--color-primary);
    color: var(--color-accent);
    font-weight: 900;
    cursor: pointer;
    transition: transform 160ms ease, opacity 160ms ease;
    user-select: none;
  }

  .product-card__cta:hover {
    transform: translateY(-1px);
  }

  .product-card__cta:active {
    transform: translateY(0);
  }

  .product-card__cta--disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .product-card__cta.is-loading {
    opacity: 0.8;
    cursor: progress;
  }

  .product-card--compact {
    border-radius: 12px;
    --product-card-media-ratio: 16 / 9;
  }

  .product-card--compact .product-card__badge {
    inset-block-start: 10px;
    inset-inline-start: 10px;
    padding: 4px 8px;
    font-size: 0.72rem;
  }

  .product-card--compact .product-card__content {
    padding: 7px 9px 9px 9px;
    gap: 3px;
  }

  .product-card--compact .product-card__title {
    font-size: 0.86rem;
    line-height: 1.2;
  }

  .product-card--compact .product-card__vendor {
    font-size: 0.78rem;
  }

  .product-card--compact .product-card__price {
    gap: 8px;
  }

  .product-card--compact .product-card__cta {
    padding: 0.55rem 0.75rem;
    font-size: 0.86rem;
  }

  @media (prefers-reduced-motion: reduce) {
    .product-card {
      transition: none;
    }

    .product-card:hover {
      transform: none;
    }
  }
{% endstylesheet %}

{% javascript %}
  if (!window.__bfQuickAddBound) {
    window.__bfQuickAddBound = true

    const setButtonLabel = (button, label) => {
      if (!button) return
      button.textContent = label
    }

    const getCartCount = async () => {
      const res = await fetch('/cart.js', {
        headers: { Accept: 'application/json' },
      })
      if (!res.ok) return null
      return await res.json()
    }

    const updateHeaderCartCount = (count) => {
      const cartLink = document.querySelector('.header__cart')
      if (!cartLink) return

      let sup = cartLink.querySelector('sup')
      if (count > 0) {
        if (!sup) {
          sup = document.createElement('sup')
          cartLink.insertBefore(sup, cartLink.firstChild)
        }
        sup.textContent = String(count)
      } else if (sup) {
        sup.remove()
      }
    }

    document.addEventListener(
      'submit',
      async (event) => {
        const form = event.target
        if (!(form instanceof HTMLFormElement)) return
        if (!form.matches('[data-quick-add]')) return

        const button = form.querySelector('button[type="submit"]')
        if (!(button instanceof HTMLButtonElement)) return

        event.preventDefault()

        const defaultLabel = button.getAttribute('data-label-default') || button.textContent
        const addedLabel = button.getAttribute('data-label-added') || defaultLabel
        const errorLabel = button.getAttribute('data-label-error') || defaultLabel

        button.disabled = true
        button.classList.add('is-loading')

        try {
          const res = await fetch(form.action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', Accept: 'application/json' },
            body: new FormData(form),
          })

          if (!res.ok) throw new Error('add_failed')

          setButtonLabel(button, addedLabel)

          const cart = await getCartCount()
          if (cart && typeof cart.item_count === 'number') {
            updateHeaderCartCount(cart.item_count)
          }

          window.setTimeout(() => {
            button.disabled = false
            button.classList.remove('is-loading')
            setButtonLabel(button, defaultLabel)
          }, 1200)
        } catch (e) {
          setButtonLabel(button, errorLabel)
          window.setTimeout(() => {
            button.disabled = false
            button.classList.remove('is-loading')
            setButtonLabel(button, defaultLabel)
          }, 1500)
        }
      },
      { passive: false }
    )
  }
{% endjavascript %}


